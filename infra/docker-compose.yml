version: '3.9'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: automation
      POSTGRES_USER: automation
      POSTGRES_PASSWORD: automation
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  api:
    build:
      context: ..
      dockerfile: infra/Dockerfile.api
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__Postgres: Host=postgres;Port=5432;Database=automation;Username=automation;Password=automation
      ConnectionStrings__Redis: redis:6379
      Encryption__Key: 4ufheHp9SqMB7vpsQMzekLTnezzzpzkkkAYXl5dEpek=
      Encryption__IV: N3NP8aj+kM7mfx0Yr1lTuw==
      Oidc__Authority: https://login.microsoftonline.com/{tenant-id}/v2.0
      Oidc__Audience: secure-human-loop-api
    depends_on:
      - postgres
      - redis
    volumes:
      - ../src:/app/src
      - ../SecureHumanLoopCaptcha.sln:/app/SecureHumanLoopCaptcha.sln

  worker:
    build:
      context: ..
      dockerfile: infra/Dockerfile.worker
    environment:
      ConnectionStrings__Postgres: Host=postgres;Port=5432;Database=automation;Username=automation;Password=automation
      ConnectionStrings__Redis: redis:6379
      Encryption__Key: 4ufheHp9SqMB7vpsQMzekLTnezzzpzkkkAYXl5dEpek=
      Encryption__IV: N3NP8aj+kM7mfx0Yr1lTuw==
      Storage__Path: /data
    depends_on:
      - postgres
      - redis
    volumes:
      - worker-data:/data

volumes:
  postgres-data:
  worker-data:
